---
config:
  theme: mc
  layout: dagre
---
flowchart TB
 subgraph cli["flox-activations activate"]
        s3["Registry Module"]
        match_activation_mode{"activation mode?"}
        n37[["exec(userShell<br>&lt;RCFILE_options&gt;)"]]
        n35[["activate_in_place(userShell)"]]
        n83["print(flox-activations attach --pid X --remove Y)<br>replay environment, run profile scripts, set activation variables, etc."]
        n137["start services?"]
        n145["exec(userShell<br>&lt;RCFILE_options&gt;<br>-c command_script)"]
        apply_activation_env_exec["apply_activation_env()"]
        apply_activation_env_shell["apply_activation_env()"]
        apply_activation_env_interactive["apply_activation_env()"]
        invoke["userShell"]
        n155["wait_for_process_compose()"]
        exec_cmd["exec(cmd args)"]
        pc_start["subprocess(process-compose start)"]
        n157["subprocess(process-compose list)<br>to verify running"]
  end
 subgraph s2["process-compose"]
        n98["flox-never-exit"]
  end
 subgraph init["Initialization & Version Check"]
        LockState["Lock state.json"]
        ReadState{"Read state.json<br>exists?"}
        CheckVersion{"version == 3?"}
        ExtractPIDs["Extract PIDs from old version"]
        CheckOldPIDsRunning{"Old PIDs<br>still running?"}
        ErrorOldVersion["Error: Old version with running processes"]
        InitNewState["Initialize new ActivationState<br>version=3, ready=False"]
  end
 subgraph exec_check["Executive Check & Reset"]
        CheckExecRunning{"executive_running()?"}
        ResetState["Reset state:<br>Discard all state contents<br>(but leave start state dirs)"]
  end
 subgraph mode_check["Mode Mismatch Check"]
        CheckModeMatch{"requested_mode ==<br>state.mode?"}
        ErrorModeMismatch["Error: Mode mismatch with running processes"]
  end
 subgraph decision["Start or Attach Decision"]
        InvokeStartOrAttach["Call state.start_or_attach(store_path)"]
        CheckResult{"StartOrAttach<br>Result?"}
        CreateStartID["Create StartIdentifier:<br>{store_path, timestamp_millis}"]
  end
 subgraph start_path["Start Path (Run Hooks)"]
        SetStarting["Set ready = Starting(getpid, start_id)"]
        CreateStateDir["Create per-start state directory:<br>{store_basename}.{timestamp}/"]
        CheckExecStart{"executive_started()?"}
        SpawnExec["Spawn flox-activations executive<br>as detached process"]
        ExecSetSupreaper["Executive: Set as subreaper (Linux)"]
        ExecSignal["Executive: Send SIGUSR1 to parent"]
        WaitSignal["Parent: Wait for SIGUSR1"]
        UpdateExecPID["Update state.executive_pid = child_pid"]
        WriteStateBeforeHooks["Write state.json<br>(executive_pid must be set)"]
        UnlockForHooks["Unlock state.json"]
        RunHooks["Run activate script"]
        LockAfterHooks["Lock state.json"]
        SetReady["Set ready = True(start_id)"]
  end
 subgraph attach_path["Attach Path (Fast Path)"]
        AddAttachment["Add self to attached_pids[getpid]<br>with start_id + expiration"]
        WriteStateAttach["Write state.json<br>(executive_pid must be set)"]
        UnlockAttach["Unlock state.json"]
  end
 subgraph retry["Already Starting - Retry Loop"]
        AlreadyStarting["Another process is starting<br>(pid, start_id)"]
        UnlockRetry["Unlock state.json"]
        IncrementRetry["retries++"]
        CheckRetryLimit{"retries % 30 == 0?"}
        Sleep["Sleep 200ms"]
        ErrorMaxRetries["WARN: another process is activating (6s)"]
  end
 subgraph state_structure["State Directory Structure"]
        ShowStructure["Directory structure:<br>{runtime_dir}/activations/{env_hash}-{env_name}/<br>├── state.json<br>├── state.json.lock<br>└── {store_basename}.{timestamp}/<br>&nbsp;&nbsp;&nbsp;&nbsp;├── start.env.json<br>&nbsp;&nbsp;&nbsp;&nbsp;├── end.env.json<br>&nbsp;&nbsp;&nbsp;&nbsp;└── [shell rc files]"]
  end
 subgraph write_guard["State Write Guard"]
        WriteGuard["write_activations_json validates:<br>executive_pid != EXECUTIVE_NOT_STARTED<br>(Must have spawned executive before writing)"]
  end
 subgraph s3["<br>"]
        Start["Begin activate"]
        init
        exec_check
        mode_check
        decision
        start_path
        attach_path
        retry
        Done["Done: PID attached to start_id<br>{store_path, timestamp}"]
  end
 subgraph activate["activate (bash)"]
        n7[["source &lt;(flox-activations set-env-dirs)<br>source &lt;(flox-activations fix-paths)"]]
        n6["source etc-profiles"]
        nd["set_manifest_vars<br>source hook.on-activate<br>"]
        n63[["Capture end.env.json"]]
        n167["Capture start.env.json"]
  end
 subgraph colorkey["Color Key"]
        node_aqepkktvr["rust"]
        n0["bash"]
        nz["userShell"]
        n110["state.json<br>logic<br>(in rust)"]
        n165(["untracked<br>activation"])
  end
 subgraph executive["Executive"]
        ns[["Monitoring loop"]]
        ny[["Clean up activation state directory"]]
        n66[["stop-process-compose()"]]
        n125["register SIGUSR1 signal handler<br>"]
        n100@{ label: "- setsid()<br style=\"--tw-scale-x:\">- register as subreaper (Linux)<br><span style=\"padding-left:\">- register SIGUSR1 signal handler</span>" }
        n148["SIGUSR1 signal handler:<br>start_process_compose()<br>using latest store path in activation state"]
        s2
        n162["PIDs exited?"]
        n163["Cleanup stale start state directories"]
        n164["Future work:<br>Submit metrics"]
  end
 subgraph invoke["userShell"]
    direction TB
        n82(["interactive or command"])
        n141@{ label: "<span style=\"background-color:\">Profile scripts</span><br>" }
        n142["Replay environment, set activation variables, etc."]
        n143["source user dotfiles"]
  end
 subgraph s4["Flox CLI w tokio"]
        n88["parse args"]
        n89{"activate()<br>services(start)"}
        n36["Initialise ActivateCtx"]
  end
    Start --> LockState
    LockState --> ReadState
    ReadState -- No --> InitNewState
    ReadState -- Yes --> CheckVersion
    CheckVersion -- No --> ExtractPIDs
    ExtractPIDs --> CheckOldPIDsRunning
    CheckOldPIDsRunning -- Yes --> ErrorOldVersion
    CheckOldPIDsRunning -- No --> InitNewState
    CheckVersion -- Yes --> CheckExecRunning
    InitNewState --> CheckExecRunning
    CheckExecRunning -- No --> ResetState
    CheckExecRunning -- Yes --> CheckModeMatch
    ResetState --> CheckModeMatch
    CheckModeMatch -- No --> ErrorModeMismatch
    CheckModeMatch -- Yes --> InvokeStartOrAttach
    InvokeStartOrAttach --> CheckResult
    CheckResult -- Start --> CreateStartID
    CheckResult -- Attach --> AddAttachment
    CheckResult -- AlreadyStarting --> AlreadyStarting
    CreateStartID --> SetStarting
    SetStarting --> CreateStateDir
    CreateStateDir -. (for reference) .-> ShowStructure
    CreateStateDir --> CheckExecStart
    CheckExecStart -- No --> SpawnExec
    CheckExecStart -- Yes --> WriteStateBeforeHooks
    WriteStateBeforeHooks -. validates .-> WriteGuard
    WriteStateBeforeHooks --> UnlockForHooks
    UnlockForHooks --> RunHooks
    RunHooks -- (wait for activate script to complete) --> LockAfterHooks
    RunHooks -- subprocess --> n7
    LockAfterHooks --> SetReady
    SetReady --> AddAttachment
    WriteStateAttach -. validates .-> WriteGuard
    WriteStateAttach --> UnlockAttach
    UnlockAttach --> Done
    AlreadyStarting --> UnlockRetry
    UnlockRetry --> IncrementRetry
    IncrementRetry --> CheckRetryLimit
    CheckRetryLimit -- Yes --> Sleep
    Sleep --> LockState
    CheckRetryLimit -- No --> ErrorMaxRetries
    SpawnExec --> ExecSetSupreaper & WaitSignal
    ExecSetSupreaper --> ExecSignal
    ExecSignal -. SIGUSR1 .-> WaitSignal
    WaitSignal --> UpdateExecPID
    UpdateExecPID --> WriteStateBeforeHooks
    ns --> n162
    node_aqepkktvr ~~~ n0
    n0 ~~~ nz
    n137 -- continue if activating --> match_activation_mode
    match_activation_mode -- in place --> n35
    match_activation_mode -- "flox activate -- cmd args" --> apply_activation_env_exec
    match_activation_mode -- interactive --> apply_activation_env_interactive
    apply_activation_env_exec --> exec_cmd
    nd --> n63
    nd -- cmd<br>mode --> n169(["exec args"])
    A(["Parent PID<br>flox activate<br>"]) -- fork() &amp;&amp; exec(flox) --> n88
    n88 --> n89
    n89 --> n36
    n100 ~~~ n7
    nz ~~~ n110
    n125 --> n100
    n35 --> n83
    n66 --> ny
    n141 --> n82
    n142 --> n141
    n37 --> invoke
    n145 --> invoke
    n155 --> pc_start
    n155 -- SIGUSR1 --> n148
    n137 -- yes --> n155
    pc_start --> n157
    n148 --> s2
    n100 --> ns
    n100 -- SIGUSR1 --> WaitSignal
    n162 -- All PIDs --> n66
    n162 -- Some PIDs --> n163
    n163 --> ns
    n162 -- No PIDs --> ns
    n143 --> n142
    match_activation_mode -- "<span style=padding-left:>flox activate -c 'command script'</span>" --> apply_activation_env_shell
    apply_activation_env_shell --> n145
    apply_activation_env_interactive --> n37
    n7 -- cmd<br>mode --> n6
    n7 --> n167
    n6 --> nd
    n160(["Container entrypoint"]) --> Start
    n36 --> Start
    n63 ~~~ LockAfterHooks
    SpawnExec -- child --> n125
    Done --> n137
    AddAttachment --> WriteStateAttach
    ErrorMaxRetries --> Sleep
    ny --> n164
    n110 --> n165
    n166(["flox-build.mk"]) -- "activate -- cmd args<br>activate -c 'cmd &amp;&amp; cmd'" --> activate
    n167 --> n6

    n83@{ shape: doc}
    n137@{ shape: diam}
    pc_start@{ shape: rect}
    n167@{ shape: subproc}
    n100@{ shape: rect}
    n162@{ shape: diam}
    n164@{ shape: subproc}
    n141@{ shape: subproc}
    n142@{ shape: rect}
    style s3 fill:transparent
    style match_activation_mode fill:#FFE0B2
    style n37 fill:#FFE0B2
    style n35 fill:#FFE0B2
    style n83 fill:#FFE0B2
    style n137 fill:#FFE0B2
    style n145 fill:#FFE0B2
    style apply_activation_env_exec fill:#FFE0B2
    style apply_activation_env_shell fill:#FFE0B2
    style apply_activation_env_interactive fill:#FFE0B2
    style n155 fill:#FFE0B2
    style pc_start fill:#FFE0B2
    style n157 fill:#FFE0B2
    style exec_cmd fill:#FFE0B2
    style ErrorOldVersion fill:#ffe1e1
    style ResetState fill:#ffebcc
    style ErrorModeMismatch fill:#ffe1e1
    style ErrorMaxRetries fill:#FFD600
    style ShowStructure fill:#f0f0f0,stroke:#999,stroke-dasharray: 5 5
    style WriteGuard fill:#fff3cd,stroke:#856404,stroke-dasharray: 5 5
    style Start fill:#e1f5e1
    style Done fill:#e1f5e1
    style n7 fill:#BBDEFB
    style n6 fill:#BBDEFB
    style nd fill:#BBDEFB
    style n63 fill:#BBDEFB
    style n167 fill:#BBDEFB
    style node_aqepkktvr fill:#FFE0B2
    style n0 fill:#BBDEFB
    style nz fill:#E1BEE7
    style n110 fill:#C8E6C9
    style n165 fill:#FFF9C4,stroke-width:2px,stroke-dasharray: 2
    style ns fill:#FFE0B2
    style ny fill:#FFE0B2
    style n66 fill:#FFE0B2
    style n125 fill:#FFE0B2
    style n100 fill:#FFE0B2
    style n148 fill:#FFE0B2
    style s2 fill:#F8F8F8
    style n162 fill:#FFE0B2
    style n163 fill:#FFE0B2
    style n164 fill:#FFE0B2,stroke-width:4px,stroke-dasharray: 5
    style n82 fill:#E1BEE7
    style n141 fill:#E1BEE7
    style n142 fill:#E1BEE7
    style n143 fill:#E1BEE7,stroke-width:4px,stroke-dasharray: 0
    style n88 fill:#FFE0B2
    style n89 fill:#FFE0B2
    style n36 fill:#FFE0B2
    style n169 fill:#FFF9C4,stroke-width:2px,stroke-dasharray: 2
    style A fill:#FFFFFF
    style n166 fill:#FFF9C4,stroke-width:2px,stroke-dasharray: 2
    style activate fill:#F8F8F8
    style s4 fill:transparent
    style cli fill:#F8F8F8
    style executive fill:#F8F8F8

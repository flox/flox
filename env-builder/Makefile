# ============================================================================ #
#
#
#
# ---------------------------------------------------------------------------- #

ROOT_DIR := $(patsubst %/,%,$(dir $(abspath $(lastword $(MAKEFILE_LIST)))))
export ROOT_DIR

# ---------------------------------------------------------------------------- #

include mk/config.mk

# ---------------------------------------------------------------------------- #

BINS    =  flox-env-builder
LIBS    =  libenvbuilder
HEADERS =  $(wildcard include/*.hh include/flox/*.hh include/nix/*.hh)


# ---------------------------------------------------------------------------- #

include mk/deps.mk
include mk/lib.mk
include mk/ccls.mk
include mk/clean.mk
include mk/check.mk
include mk/docs.mk
include src/Include.mk


# ---------------------------------------------------------------------------- #

CXX     ?= c++
MKDIR   ?= mkdir
MKDIR_P ?= $(MKDIR) -p
CP      ?= cp


# ---------------------------------------------------------------------------- #

CPPFLAGS ?=
LDLIBS   ?=

CXXFLAGS ?=
CXXFLAGS += -Iinclude
CXXFLAGS += $(nix_CFLAGS) $(sqlite3pp_CFLAGS)

LDFLAGS ?=
# TODO: -Wl is not available on gh runners?
# LDFLAGS += -Wl,-rpath,$$ORIGIN/../lib
# LDFLAGS += -Wl,--enable-new-dtags '-Wl,-rpath,$$ORIGIN/../lib'
LDFLAGS += $(nix_LDFLAGS)


bin_CPPFLAGS ?=
bin_CXXFLAGS += -D'PROFILE_D_SCRIPT_DIR="$(PROFILE_D_SCRIPT_DIR)"'
bin_CXXFLAGS += -D'SET_PROMPT_BASH_SH="$(SET_PROMPT_BASH_SH)"'
bin_LDFLAGS  ?= -Llib
bin_LDLIBS   ?=

lib_CPPFLAGS ?=
lib_CXXFLAGS ?= -shared -fPIC
# TODO: -Wl is not available on gh runners?

lib_LDFLAGS  ?= -shared -fPIC
# lib_LDFLAGS  ?= -shared -fPIC -Wl,--no-undefined
lib_LDLIBS   ?=


# ---------------------------------------------------------------------------- #

ifneq (,$(DEBUG))
CXXFLAGS += -ggdb3 -pg -fno-omit-frame-pointer
LDFLAGS  += -ggdb3 -pg -fno-omit-frame-pointer
endif

ifneq (,$(COV))
CXXFLAGS += --coverage -fprofile-arcs -ftest-coverage
LDFLAGS  += --coverage -fprofile-arcs -ftest-coverage
endif


# ---------------------------------------------------------------------------- #

ifneq (,$(SEMVER))
CXXFLAGS += -DSEMVER_PATH='$(SEMVER)'
endif


# ---------------------------------------------------------------------------- #

include mk/gen-targets.mk
# This needs to come after we run our templates.
include mk/install.mk


# ---------------------------------------------------------------------------- #

.PHONY: all
.DEFAULT_GOAL = all

all: bin lib include tests


# ---------------------------------------------------------------------------- #
#
#
#
# ============================================================================ #

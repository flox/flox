name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  build:
    name: Build and test flox on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os:
        - ubuntu-22.04-8core
        - macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Install flox
      uses: flox/install-flox-action@next
      with:
        github-access-token: ${{ secrets.NIX_GIT_TOKEN }}
        substituter: s3://flox-store
        substituter-key: ${{ secrets.FLOX_STORE_PUBLIC_NIX_SECRET_KEY }}
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Build flox-gh
      run: |
        flox nix -- build '.#flox-gh' -L --no-update-lock-file      \
                                      --print-out-paths --no-link;

    - name: Build nix-editor
      run: |
        flox nix -- build '.#nix-editor' -L --no-update-lock-file      \
                                         --print-out-paths --no-link;

    - name: Build builtfilter-rs
      run: |
        flox nix -- build '.#builtfilter-rs' -L --no-update-lock-file      \
                                             --print-out-paths --no-link;

    - name: Build flox-bash
      run: |
        flox nix -- build '.#flox-bash-dev' -L --no-update-lock-file      \
                                            --print-out-paths --no-link;

    # These cannot be run offline so we need to build in our tree.
    # This just builds the `flox' deps so that they can get cached.
    - name: Build Rust Env
      run: flox nix -- develop '.#flox' --no-update-lock-file -c true;

    - name: Build flox
      run: |
        flox nix -- build '.#flox-dev' -L --no-update-lock-file  \
                                       --print-out-paths;
        echo "FLOX_CLI=$( readlink -f ./result; )/bin/flox" >> "$GITHUB_ENV";
        rm ./result;

    - name: Build flox-tests
      run: |
        flox nix -- build '.#flox-tests' -L --no-update-lock-file      \
                                         --print-out-paths --no-link;

    # We ultimately test against the `FLOX_CLI' env var's path set earlier.
    - name: Bats Tests
      run: |
        git clean -xfd;
        nix run --no-update-lock-file '.#flox-tests';

name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:

  check-user:
    runs-on: ubuntu-latest
    name: Check User is a Flox Member
    outputs:
      isFloxUser: ${{ steps.check-user.outputs.isFloxUser }}
    steps:
    - id: check-user
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if gh api -H 'Accept: application/vnd.github+json'  \
                  -H 'X-GitHub-Api-Version: 2022-11-28'     \
                  /orgs/flox/members/${{ github.actor }};
        then
          echo 'isFloxUser=true' >> "$GITHUB_OUTPUT";
        else
          echo 'isFloxUser=false' >> "$GITHUB_OUTPUT";
        fi

  build:
    name: Build ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: check-user

    strategy:
      matrix:
        include:
          - package: flox
          - package: flox-bash
          - package: nix-editor

    steps:

    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Install flox
      uses: flox/install-flox-action@main
      with:
        github-access-token: ${{ secrets.NIX_GIT_TOKEN }}

    - name: Setup Caches
      if: ${{ needs.check-user.outputs.isFloxUser == 'true' }}
      uses: cachix/cachix-action@main
      with:
        authToken: ${{ secrets.AWS_ACCESS_KEY_ID }}
        signingKey: ${{ secrets.FLOX_STORE_PUBLIC_NIX_SECRET_KEY }}
        cachixArgs: --hostname s3://flox-store-public
        skipAddingSubstituter: true
        name: floxdev

    - name: Build
      run: flox build ${{ matrix.package }} -L
